# é£é™©ç®¡ç†å›¢é˜Ÿ

## æ¦‚è¿°

é£é™©ç®¡ç†å›¢é˜Ÿæ˜¯ TradingAgents æ¡†æ¶çš„é£é™©æ§åˆ¶æ ¸å¿ƒï¼Œè´Ÿè´£ä»å¤šä¸ªè§’åº¦è¯„ä¼°å’Œè´¨ç–‘æŠ•èµ„å†³ç­–ï¼Œç¡®ä¿æŠ•èµ„ç»„åˆçš„é£é™©å¯æ§æ€§ã€‚å›¢é˜Ÿç”±ä¸åŒé£é™©åå¥½çš„åˆ†æå¸ˆç»„æˆï¼Œé€šè¿‡å¤šè§’åº¦çš„é£é™©è¯„ä¼°å’Œåé©³æœºåˆ¶ï¼Œä¸ºæŠ•èµ„å†³ç­–æä¾›å…¨é¢çš„é£é™©è§†è§’å’Œä¿æŠ¤æªæ–½ã€‚

## é£é™©ç®¡ç†æ¶æ„

### åŸºç¡€è®¾è®¡

é£é™©ç®¡ç†å›¢é˜ŸåŸºäºç»Ÿä¸€çš„æ¶æ„è®¾è®¡ï¼Œä¸“æ³¨äºé£é™©è¯†åˆ«ã€è¯„ä¼°å’Œæ§åˆ¶ï¼š

```python
# ç»Ÿä¸€çš„é£é™©ç®¡ç†æ¨¡å—æ—¥å¿—è£…é¥°å™¨
from tradingagents.utils.tool_logging import log_risk_module

# ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ
from tradingagents.utils.logging_init import get_logger
logger = get_logger("default")

@log_risk_module("risk_type")
def risk_node(state):
    # é£é™©ç®¡ç†é€»è¾‘å®ç°
    pass
```

### æ™ºèƒ½ä½“çŠ¶æ€ç®¡ç†

é£é™©ç®¡ç†å›¢é˜Ÿé€šè¿‡ `AgentState` è·å–å®Œæ•´çš„æŠ•èµ„å†³ç­–ä¿¡æ¯ï¼š

```python
class AgentState:
    company_of_interest: str      # è‚¡ç¥¨ä»£ç 
    trade_date: str              # äº¤æ˜“æ—¥æœŸ
    fundamentals_report: str     # åŸºæœ¬é¢æŠ¥å‘Š
    market_report: str           # å¸‚åœºåˆ†ææŠ¥å‘Š
    news_report: str             # æ–°é—»åˆ†ææŠ¥å‘Š
    sentiment_report: str        # æƒ…ç»ªåˆ†ææŠ¥å‘Š
    trader_recommendation: str   # äº¤æ˜“å‘˜å»ºè®®
    messages: List              # æ¶ˆæ¯å†å²
```

## é£é™©ç®¡ç†å›¢é˜Ÿæˆå‘˜

### 1. ä¿å®ˆé£é™©åˆ†æå¸ˆ (Conservative Risk Analyst)

**æ–‡ä»¶ä½ç½®**: `tradingagents/agents/risk_mgmt/conservative_debator.py`

**æ ¸å¿ƒèŒè´£**:
- ä½œä¸ºå®‰å…¨/ä¿å®ˆé£é™©åˆ†æå¸ˆ
- ç§¯æåé©³æ¿€è¿›å’Œä¸­æ€§åˆ†æå¸ˆçš„è®ºç‚¹
- æŒ‡å‡ºæ½œåœ¨é£é™©å¹¶æå‡ºæ›´è°¨æ…çš„æ›¿ä»£æ–¹æ¡ˆ
- ä¿æŠ¤èµ„äº§ã€æœ€å°åŒ–æ³¢åŠ¨æ€§å¹¶ç¡®ä¿ç¨³å®šå¢é•¿

**æ ¸å¿ƒå®ç°**:
```python
def create_safe_debator(llm):
    @log_risk_module("conservative")
    def safe_node(state):
        # è·å–åŸºç¡€ä¿¡æ¯
        company_name = state["company_of_interest"]
        trader_recommendation = state.get("trader_recommendation", "")
        
        # è·å–è‚¡ç¥¨å¸‚åœºä¿¡æ¯
        from tradingagents.utils.stock_utils import StockUtils
        market_info = StockUtils.get_market_info(company_name)
        
        # ç¡®å®šè‚¡ç¥¨ç±»å‹å’Œè´§å¸ä¿¡æ¯
        if market_info.get("is_china"):
            stock_type = "Aè‚¡"
            currency_unit = "äººæ°‘å¸"
        elif market_info.get("is_hk"):
            stock_type = "æ¸¯è‚¡"
            currency_unit = "æ¸¯å¸"
        elif market_info.get("is_us"):
            stock_type = "ç¾è‚¡"
            currency_unit = "ç¾å…ƒ"
        else:
            stock_type = "æœªçŸ¥å¸‚åœº"
            currency_unit = "æœªçŸ¥è´§å¸"
        
        # è·å–å„ç±»åˆ†ææŠ¥å‘Š
        market_report = state.get("market_report", "")
        sentiment_report = state.get("sentiment_report", "")
        news_report = state.get("news_report", "")
        fundamentals_report = state.get("fundamentals_report", "")
        
        # æ„å»ºä¿å®ˆé£é™©åˆ†ææç¤º
        safe_prompt = f"""
        ä½œä¸ºå®‰å…¨/ä¿å®ˆé£é™©åˆ†æå¸ˆï¼Œè¯·å¯¹ä»¥ä¸‹æŠ•èµ„å†³ç­–è¿›è¡Œé£é™©è¯„ä¼°ï¼š
        
        å…¬å¸åç§°: {company_name}
        è‚¡ç¥¨ç±»å‹: {stock_type}
        è´§å¸å•ä½: {currency_unit}
        
        äº¤æ˜“å‘˜å»ºè®®: {trader_recommendation}
        
        å¸‚åœºç ”ç©¶æŠ¥å‘Š: {market_report}
        æƒ…ç»ªæŠ¥å‘Š: {sentiment_report}
        æ–°é—»æŠ¥å‘Š: {news_report}
        åŸºæœ¬é¢æŠ¥å‘Š: {fundamentals_report}
        
        è¯·ä»ä¿å®ˆè§’åº¦åˆ†æï¼š
        1. è¯†åˆ«æ‰€æœ‰æ½œåœ¨é£é™©å› ç´ 
        2. è´¨ç–‘ä¹è§‚å‡è®¾çš„åˆç†æ€§
        3. æå‡ºæ›´è°¨æ…çš„æ›¿ä»£æ–¹æ¡ˆ
        4. å»ºè®®é£é™©æ§åˆ¶æªæ–½
        5. è¯„ä¼°æœ€åæƒ…å†µä¸‹çš„æŸå¤±
        """
        
        # è°ƒç”¨LLMç”Ÿæˆé£é™©åˆ†æ
        response = llm.invoke(safe_prompt)
        
        return {"conservative_risk_analysis": response.content}
```

**åˆ†æç‰¹ç‚¹**:
- **é£é™©ä¼˜å…ˆ**: ä¼˜å…ˆè¯†åˆ«å’Œå¼ºè°ƒå„ç±»é£é™©å› ç´ 
- **ä¿å®ˆä¼°å€¼**: å€¾å‘äºæ›´ä¿å®ˆçš„ä¼°å€¼å’Œé¢„æœŸ
- **é˜²å¾¡ç­–ç•¥**: é‡ç‚¹å…³æ³¨èµ„æœ¬ä¿æŠ¤å’Œé£é™©æ§åˆ¶
- **è´¨ç–‘ä¹è§‚**: å¯¹ä¹è§‚é¢„æœŸå’Œå‡è®¾ä¿æŒè´¨ç–‘æ€åº¦

## é£é™©è¯„ä¼°ç»´åº¦

### 1. å¸‚åœºé£é™©

**ç³»ç»Ÿæ€§é£é™©**:
- å®è§‚ç»æµé£é™©
- æ”¿ç­–ç›‘ç®¡é£é™©
- åˆ©ç‡æ±‡ç‡é£é™©
- åœ°ç¼˜æ”¿æ²»é£é™©

**éç³»ç»Ÿæ€§é£é™©**:
- è¡Œä¸šå‘¨æœŸé£é™©
- å…¬å¸ç‰¹å®šé£é™©
- ç®¡ç†å±‚é£é™©
- ç«äº‰ç¯å¢ƒé£é™©

### 2. æµåŠ¨æ€§é£é™©

**å¸‚åœºæµåŠ¨æ€§**:
- äº¤æ˜“é‡åˆ†æ
- ä¹°å–ä»·å·®è¯„ä¼°
- å¸‚åœºæ·±åº¦åˆ†æ
- å†²å‡»æˆæœ¬è¯„ä¼°

**èµ„é‡‘æµåŠ¨æ€§**:
- ç°é‡‘æµåˆ†æ
- èèµ„èƒ½åŠ›è¯„ä¼°
- å€ºåŠ¡åˆ°æœŸåˆ†æ
- è¥è¿èµ„é‡‘ç®¡ç†

### 3. ä¿¡ç”¨é£é™©

**è´¢åŠ¡é£é™©**:
- å€ºåŠ¡è´Ÿæ‹…è¯„ä¼°
- å¿å€ºèƒ½åŠ›åˆ†æ
- ç°é‡‘æµç¨³å®šæ€§
- ç›ˆåˆ©è´¨é‡è¯„ä¼°

**è¿è¥é£é™©**:
- ä¸šåŠ¡æ¨¡å¼é£é™©
- ç®¡ç†å±‚é£é™©
- å†…æ§åˆ¶åº¦é£é™©
- åˆè§„é£é™©

### 4. ä¼°å€¼é£é™©

**ä¼°å€¼æ–¹æ³•é£é™©**:
- ä¼°å€¼æ¨¡å‹é€‰æ‹©
- å‚æ•°æ•æ„Ÿæ€§åˆ†æ
- å‡è®¾æ¡ä»¶è¯„ä¼°
- æ¯”è¾ƒåŸºå‡†é€‰æ‹©

**å¸‚åœºä¼°å€¼é£é™©**:
- å¸‚åœºæƒ…ç»ªå½±å“
- ä¼°å€¼æ³¡æ²«é£é™©
- ä»·æ ¼å‘ç°æ•ˆç‡
- æŠ•èµ„è€…ç»“æ„å½±å“

## é…ç½®é€‰é¡¹

### é£é™©ç®¡ç†é…ç½®

```python
risk_config = {
    "risk_tolerance": "moderate",      # é£é™©å®¹å¿åº¦
    "max_portfolio_var": 0.05,         # æœ€å¤§ç»„åˆVaR
    "max_single_position": 0.05,       # æœ€å¤§å•ä¸€ä»“ä½
    "max_sector_exposure": 0.20,       # æœ€å¤§è¡Œä¸šæ•å£
    "correlation_threshold": 0.70,     # ç›¸å…³æ€§é˜ˆå€¼
    "rebalance_trigger": 0.05,         # å†å¹³è¡¡è§¦å‘é˜ˆå€¼
    "stress_test_frequency": "weekly"  # å‹åŠ›æµ‹è¯•é¢‘ç‡
}
```

## æ—¥å¿—å’Œç›‘æ§

### è¯¦ç»†æ—¥å¿—è®°å½•

```python
# é£é™©ç®¡ç†æ´»åŠ¨æ—¥å¿—
logger.info(f"ğŸ›¡ï¸ [é£é™©ç®¡ç†] å¼€å§‹é£é™©è¯„ä¼°: {company_name}")
logger.info(f"ğŸ“Š [é£é™©åˆ†æ] è‚¡ç¥¨ç±»å‹: {stock_type}, è´§å¸: {currency_unit}")
logger.debug(f"âš ï¸ [é£é™©å› ç´ ] è¯†åˆ«åˆ° {len(risk_factors)} ä¸ªé£é™©å› ç´ ")
logger.warning(f"ğŸš¨ [é£é™©é¢„è­¦] å‘ç°é«˜é£é™©å› ç´ : {high_risk_factors}")
logger.info(f"âœ… [é£é™©è¯„ä¼°] é£é™©åˆ†æå®Œæˆï¼Œé£é™©ç­‰çº§: {risk_level}")
```

### é£é™©ç›‘æ§æŒ‡æ ‡

- é£é™©è¯„ä¼°å‡†ç¡®æ€§
- é£é™©é¢„è­¦åŠæ—¶æ€§
- é£é™©æ§åˆ¶æœ‰æ•ˆæ€§
- æŸå¤±é¢„æµ‹ç²¾åº¦
- é£é™©è°ƒæ•´æ”¶ç›Š

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„é£é™©åˆ†æå¸ˆ

1. **åˆ›å»ºæ–°çš„é£é™©åˆ†æå¸ˆæ–‡ä»¶**
```python
# tradingagents/agents/risk_mgmt/new_risk_analyst.py
from tradingagents.utils.tool_logging import log_risk_module
from tradingagents.utils.logging_init import get_logger

logger = get_logger("default")

def create_new_risk_analyst(llm):
    @log_risk_module("new_risk_type")
    def new_risk_node(state):
        # æ–°çš„é£é™©åˆ†æé€»è¾‘
        pass
    
    return new_risk_node
```

2. **é›†æˆåˆ°é£é™©ç®¡ç†ç³»ç»Ÿ**
```python
# åœ¨ç›¸åº”çš„å›¾é…ç½®ä¸­æ·»åŠ æ–°çš„é£é™©åˆ†æå¸ˆ
from tradingagents.agents.risk_mgmt.new_risk_analyst import create_new_risk_analyst

new_risk_analyst = create_new_risk_analyst(llm)
```

## æœ€ä½³å®è·µ

### 1. å…¨é¢é£é™©è¯†åˆ«
- ç³»ç»Ÿæ€§è¯†åˆ«å„ç±»é£é™©
- å®šæœŸæ›´æ–°é£é™©æ¸…å•
- å…³æ³¨æ–°å…´é£é™©å› ç´ 
- å»ºç«‹é£é™©åˆ†ç±»ä½“ç³»

### 2. é‡åŒ–é£é™©ç®¡ç†
- ä½¿ç”¨å¤šç§é£é™©æŒ‡æ ‡
- å®šæœŸæ ¡å‡†é£é™©æ¨¡å‹
- è¿›è¡Œå›æµ‹éªŒè¯
- æŒç»­ä¼˜åŒ–å‚æ•°

### 3. åŠ¨æ€é£é™©æ§åˆ¶
- å®æ—¶ç›‘æ§é£é™©æ°´å¹³
- åŠæ—¶è°ƒæ•´é£é™©æ•å£
- çµæ´»åº”å¯¹å¸‚åœºå˜åŒ–
- ä¿æŒé£é™©é¢„ç®—å¹³è¡¡

### 4. é€æ˜é£é™©æ²Ÿé€š
- æ¸…æ™°ä¼ è¾¾é£é™©ä¿¡æ¯
- å®šæœŸå‘å¸ƒé£é™©æŠ¥å‘Š
- åŠæ—¶å‘å‡ºé£é™©é¢„è­¦
- æä¾›é£é™©æ•™è‚²åŸ¹è®­

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **é£é™©åˆ†æå¤±è´¥**
   - æ£€æŸ¥è¾“å…¥æ•°æ®å®Œæ•´æ€§
   - éªŒè¯LLMè¿æ¥çŠ¶æ€
   - ç¡®è®¤è‚¡ç¥¨å¸‚åœºä¿¡æ¯è·å–
   - æ£€æŸ¥æ—¥å¿—è®°å½•

2. **é£é™©è¯„ä¼°ä¸å‡†ç¡®**
   - æ›´æ–°é£é™©æ¨¡å‹å‚æ•°
   - å¢åŠ å†å²æ•°æ®æ ·æœ¬
   - è°ƒæ•´é£é™©å› å­æƒé‡
   - ä¼˜åŒ–è¯„ä¼°ç®—æ³•

3. **é£é™©æ§åˆ¶è¿‡åº¦ä¿å®ˆ**
   - è°ƒæ•´é£é™©å®¹å¿åº¦å‚æ•°
   - å¹³è¡¡é£é™©ä¸æ”¶ç›Šç›®æ ‡
   - ä¼˜åŒ–ä»“ä½ç®¡ç†ç­–ç•¥
   - è€ƒè™‘å¸‚åœºç¯å¢ƒå˜åŒ–

### è°ƒè¯•æŠ€å·§

1. **é£é™©åˆ†æè°ƒè¯•**
```python
logger.debug(f"é£é™©åˆ†æè¾“å…¥: å…¬å¸={company_name}, ç±»å‹={stock_type}")
logger.debug(f"é£é™©å› ç´ è¯†åˆ«: {risk_factors}")
logger.debug(f"é£é™©è¯„ä¼°ç»“æœ: {risk_assessment}")
```

2. **çŠ¶æ€éªŒè¯**
```python
logger.debug(f"çŠ¶æ€æ£€æŸ¥: åŸºæœ¬é¢æŠ¥å‘Šé•¿åº¦={len(fundamentals_report)}")
logger.debug(f"çŠ¶æ€æ£€æŸ¥: å¸‚åœºæŠ¥å‘Šé•¿åº¦={len(market_report)}")
logger.debug(f"çŠ¶æ€æ£€æŸ¥: äº¤æ˜“å‘˜å»ºè®®={trader_recommendation[:100]}...")
```

é£é™©ç®¡ç†å›¢é˜Ÿä½œä¸ºTradingAgentsæ¡†æ¶çš„å®‰å…¨å®ˆæŠ¤è€…ï¼Œé€šè¿‡å…¨é¢çš„é£é™©è¯†åˆ«ã€è¯„ä¼°å’Œæ§åˆ¶ï¼Œç¡®ä¿æŠ•èµ„å†³ç­–åœ¨å¯æ§é£é™©èŒƒå›´å†…è¿›è¡Œï¼Œä¸ºæŠ•èµ„ç»„åˆçš„é•¿æœŸç¨³å¥å¢é•¿æä¾›é‡è¦ä¿éšœã€‚